#!/bin/bash

USAGE="$0 [-r=runs] [-b=batch_size] branch1 [branch2 ...]"

runs=3
batch=1

while getopts "r:b:h" opt; do
  case ${opt} in
    h)
      echo "help: $USAGE"
      exit 0
      ;;
    r)
      runs=$OPTARG
      ;;
    b)
      batch=$OPTARG
      ;;
    \? )
      echo "Usage: $USAGE"
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

if [ "$#" -lt 1 ]; then
    echo "illegal number of parameters"
    echo "$USAGE"
    exit 2
fi

jobid=$(uuidgen)

dirty=$(git status --porcelain | perl -ne '/^ M (.*)/&& print "$1, "')
if [ "$dirty" ]
then
  echo "Workspace not clean"
  exit 1
fi

b1=$1
shift

while IFS= read -r line; do
    tests+=("$line")
done < <(cat ./performance.txt)

echo "cleaning"
make clean > /dev/null
git checkout "$b1"
echo "building"
make pc pc_fre > /dev/null
./perf --batch "$batch" --runs "$runs" --jobid "$jobid" "${tests[@]}"

for b2 in "$@";
do
  echo "cleaning"
  make clean > /dev/null
  git checkout "$b2"
  echo "building"
  make pc pc_fre > /dev/null
  ./perf --batch "$batch" --runs "$runs" --jobid "$jobid" "${tests[@]}"
  ./perf_report "$jobid" "$b1" "$b2"
done

