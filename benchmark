#!/bin/bash

USAGE="$0 [-r=x] [-b=y] branch1 branch2 test [test ...]"

OPTS=$(getopt r:b:h $*)

if [ $? != 0 ] ; then echo "Failed parsing options." >&2 ; exit 1 ; fi

set -- $OPTS

runs=3
batch=1

for i
do
    case "$i" in
    -h)
      echo "help: $USAGE"
      exit 0
      ;;
    -r)
      runs=$2
      shift 2
      ;;
    -b)
      batch=$2
      shift 2
      ;;
    --)
      shift
      break
      ;;
    esac
done

if [ "$#" -le 2 ]; then
    echo "illegal number of parameters"
    echo "$USAGE"
    exit 2
fi

b1=$1
b2=$2
shift
shift

jobid=$(uuidgen)

dirty=$(git status --porcelain | perl -ne '/^ M (.*)/&& print "$1, "')
if [ "$dirty" ]
then
  echo "Workspace not clean"
  exit 1
fi

make clean

git checkout "$b1"

make pc pc_fre

./perf.pl --batch "$batch" --runs "$runs" "$jobid" "$@"

make clean

git checkout "$b2"

make pc pc_fre

./perf.pl --batch "$batch" --runs "$runs" "$jobid" "$@"

perf_report $jobid $b1 $b2

